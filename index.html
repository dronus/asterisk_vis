<html>
  <head>
    <meta charset="utf-8">
    <title>Asterisk Connection Map</title>
    <script src="svg.js"></script>
    <style>
    body,html,*{
      padding:0;
      margin: 0;
      cursor: crosshair !important;
      zoom:0.89;
    }
    body{
/*      transform-origin: 50vh 50vh;
      transform: rotate(-90deg);*/
/*      width: 3200px;
      height: 1080px;*/
      overflow: hidden;
    }
    #messages{
      position: absolute;
      bottom: 0px; right: 0px;
      width: 500px; height: 500px;
    }
    </style>
  </head>

  <body>
    <textarea id=messages></textarea>

    <object id=map width=1920 data="cl-map.svg" type="image/svg+xml"></object>
    <script>

      var session_id="asterisk_vis"; //+(""+Math.random()).substring(2);
      var svg=null; 
      var lines={};

      var ids_to_exts={};


      function set_online(online)
      {
        if(online){
          svg.select('#offline').hide();
        }
        else {
          svg.select('#offline').show();
        }
      }

      function line_add(a,b,thickness){
        line_remove(a,b);

        var o1=svg.select('#phone-'+a).members[0];
        var o2=svg.select('#phone-'+b).members[0];

        if(!o1 || !o2) return;

        var line=svg.line(o1.cx(),o1.cy(),o2.cx(),o2.cy()).attr('id',"line_"+a+"_"+b);
        line.stroke({ color: '#ffffff', width: thickness, linecap: 'round' });
      }
      function line_remove(a,b){
        var lines=svg.select("#line_"+a+"_"+b);
        for(var line of lines.members) line.remove();
        var lines=svg.select("#line_"+b+"_"+a);
        for(var line of lines.members) line.remove();
      }

      function message_handler(msg){
        // messages.value+=msg.data+"\n";
        var data=JSON.parse(msg.data);

       //if(data.type=="PeerStatusChange") return;

        console.log(data);
      
        
        if(data.type=='Dial')
        {
          var from=data.caller.caller.number;
          var to  =data.peer.caller.number;

          console.log('Dial from '+from+' to '+to);

          from=ids_to_exts[parseInt(from)];
          if(!from || !svg.select('#phone-'+from).length()) return; // from='undefined';
          if(!to   || !svg.select('#phone-'+to  ).length()) to  ='undefined';

          var o1=svg.select('#phone-'+from).addClass('active').members[0];
          var o2=svg.select('#phone-'+to  ).addClass('active').members[0];

          // if(!  o1 || !o2) return;
          
          line_add(from,to,2);          
        }


      if(data.type=='ChannelEnteredBridge' && data.bridge.channels.length==2)
        {

          var from=data.channel.caller.number;
          var to  =data.channel.connected.number;

          console.log('ChannelEnteredBridge from '+from+' to '+to);

          from=ids_to_exts[parseInt(from)];
          if(!from || !svg.select('#phone-'+from).length()) return; //from='undefined';
          if(!to   || !svg.select('#phone-'+to  ).length()) return; //to  ='undefined';

          var o1=svg.select('#phone-'+from).addClass('active').members[0];
          var o2=svg.select('#phone-'+to  ).addClass('active').members[0];

          // if(!  o1 || !o2) return;

          line_add(from,to,2);          
//          lines_by_ext[from]=line;
//          lines_by_ext[to  ]=line;
        }

        if(data.type=='ChannelConnectedLine')
        {
          var from=data.channel.caller.number;
          var to  =data.channel.connected.number;

          console.log('Connected from '+from+' to '+to);

//          if(!from || !svg.select('#phone-'+from).length()) from='undefined';
//          if(!to   || !svg.select('#phone-'+to  ).length()) to  ='undefined';
/*
          var o1=svg.select('#phone-'+from).addClass('active').members[0];
          var o2=svg.select('#phone-'+to  ).addClass('active').members[0];
          
          //if(!o1 || !o2) return;

          var line=svg.line(o1.cx(),o1.cy(),o2.cx(),o2.cy()).attr('id',"line_"+from+"_"+to);
          line.stroke({ color: '#f06', width: 3, linecap: 'round' });
*/
        }

        if(data.type=='ChannelHangupRequest')
        {
          var from=data.channel.caller.number;
          var to  = data.channel.connected.number ? data.channel.connected.number : data.channel.dialplan.exten;

          if(ids_to_exts[parseInt(from)])  from=ids_to_exts[parseInt(from)];

          if(!from || !svg.select('#phone-'+from).length()) from='undefined';
          if(!to   || !svg.select('#phone-'+to  ).length()) to  ='undefined';
          console.log('Hangup from '+from+' to '+to);

          svg.select('#phone-'+from).removeClass('active');
          svg.select('#phone-'+to  ).removeClass('active');
  
          line_remove(from,to);
        }
      }
      var ws;
      function open_socket(){
        console.log('Opening socket');
        ws=new WebSocket('ws://192.168.179.2:8088/asterisk/ari/events?api_key=paul:<PASSWORD HERE>&app='+session_id+'&subscribeAll=true'); 
        var messages=document.getElementById('messages');
        ws.addEventListener('close',function()
        {
          // on close, try to repoen again 1s later
          console.log('Socket closed.');
          // setTimeout(open_socket,1000);
        });
        /*ws.addEventListener('error',function()
        {
          // on close, try to repoen again 1s later
          console.log('Socket error.');
          set_online(false);
          setTimeout(open_socket,1000);
        });*/
        ws.addEventListener('open',function(){
           set_online(true);
        });
        ws.addEventListener('message',message_handler);
     }; 


    function get(url,callback,errorhandler){
      var xmlHttp=new XMLHttpRequest();
      xmlHttp.open('GET', url, true);
      xmlHttp.setRequestHeader("Authorization", "Basic " + btoa("paul:<PASSWORD HERE>"));
      xmlHttp.onreadystatechange = function () {
          if (xmlHttp.readyState == 4) {
            callback(xmlHttp.responseText);
          }
      };
      xmlHttp.onerror=errorhandler;
      xmlHttp.send(null);
    }

    function update_states(){
      get('http://192.168.179.2:8088/asterisk/ari/endpoints',function(response){
        var json=response;
        if(!response) return;

        if(!ids_to_exts.length) get('http://192.168.179.2/cgi-bin/extensions',function(response){
          ids_to_exts=JSON.parse(response);
        });

        if(!ws || ws.readyState!=1) open_socket();

        var devices=JSON.parse(json);
        for(var device of devices){
          // console.log("Device "+device.resource+" "+device.state);
          var ext=ids_to_exts[parseInt(device.resource)];
          if(ext){            
            var elem=svg.select('#phone-'+ext);
            elem.removeClass('unknown').removeClass('online').removeClass('offline');
            elem.addClass(device.state);
          }
        }
      },function(){
        // can't fetch, so just close ws to reconnect it too.
        if(ws) ws.close();
        set_online(false);
      });
      setTimeout(update_states,5000);
    }

    window.addEventListener('load',function(){
      svg=SVG.adopt(document.getElementById('map').contentDocument.rootElement);
      svg.select('ellipse').style('fill','');

      update_states();
    });
    </script>
  </body>
</html>
